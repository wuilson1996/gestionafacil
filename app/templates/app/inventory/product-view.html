{% extends 'layouts/base.html' %}
{% block title %} Nuevo proveedor {% endblock title %}
{% load static %}
<!-- Specific CSS goes HERE -->
{% block stylesheets %}
{% endblock stylesheets %}

{% block content %}
<div class="container">
    <form action="/create-product" method="post" id="formId" enctype="multipart/form-data">{% csrf_token %}
    <div class="row">
        <div class="col-md-8 mt-4">
            
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Producto avanzado <i class="fas fa-upload ms-3"></i></h5>
                    </div>
                    <div class="col-lg-12 col-md-12 col-12">
                        <div class="card-body p-3">
                            <div class="row">
                                <div>
                                    <h6>INFORMACION GENERAL
                                        <button class="btn btn-link btn-nav-accordion" style="cursor: pointer; color: #495057;float: right;" type="button" data-bs-toggle="collapse" data-bs-target="#colapseInfG" aria-expanded="true" aria-controls="colapseInfG">
                                        <i class="fas fa-chevron-up"></i>
                                        </button>
                                    </h6>
                                </div>
                                <div class="accordion-item mb-0">
                                    <div id="colapseInfG" class="accordion-collapse collapse show" aria-labelledby="infG" data-bs-parent="#accordionRental">
                                        <div class="accordion-body text-sm opacity-8">
                                            <div class="mt-3 row">
                                                <input type="hidden" name="type_product" id="type_product" value="true">
                                                <div class="col-12 col-sm-6">
                                                    <div class="form-check mb-3">
                                                    <input class="form-check-input" type="radio" name="tp" id="customRadio1" checked>
                                                    <label class="custom-control-label" for="customRadio1">Producto</label>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-sm-6">
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="tp" id="customRadio2">
                                                    <label class="custom-control-label" for="customRadio2">Servicio</label>
                                                    </div>
                                                </div>
                                                </div>
                                                <div class="mt-3 row">
                                                    <div class="col-12 col-sm-8">
                                                        <label>Nombre</label>
                                                        <input class="form-control form-control-sm" id="name" name="name" type="text" required placeholder="Producto o servicio" />
                                                    </div>
                                                    <div class="col-12 col-sm-4">
                                                        <label>Cantidad</label>
                                                        <input class="form-control form-control-sm" id="cant" value="0" min="0" type="number" name="cant" required placeholder="10" />
                                                    </div>
                                                </div>
                                                <div class="mt-3 row">
                                                    <div class="col-12 col-sm-6">
                                                        <label>Referencia</label>
                                                        <input class="form-control form-control-sm" id="code" type="text" name="code" placeholder="Agrege un codigo interno" />
                                                      </div>
                                                      <div class="col-12 col-sm-6">
                                                        <label>Codigo SAT</label>
                                                        <input class="form-control form-control-sm" list="ref" id="code_sat" type="text" name="code_sat" placeholder="Codigo/Nombre de producto o servicio 'Sat'" />
                                                        <datalist id="ref">
                                          
                                                        </datalist>
                                                      </div>
                                                      <!-- <div class="col-12 col-sm-8">
                                                        <label>Codigo SAT</label>
                                                        <select class="form-control form-control-sm" name="ref" id="ref">
                                                          
                                                        </select>
                                                      </div> -->
                                                  </div>
                                                <div class="mt-3 row">
                                                    <div class="col-12 col-sm-6">
                                                        <label>Unidad de medida</label>
                                                        <select class="form-control form-control-sm" id="um" type="text" name="um" required>
                                                        {% for um in unit_measure %}
                                                            <option value="{{um.pk}}">{{um.name}}</option>
                                                        {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-12 col-sm-6">
                                                        <label>Categoria</label>
                                                        <select class="form-control form-control-sm" id="category" type="text" name="category" required>
                                                            {% for sc in category %}
                                                                <option value="{{sc.pk}}" selected>{{sc.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="mt-3 row">
                                                <div class="mt-3 col-12 col-sm-12 mt-sm-0">
                                                    <label>Descripcion</label>
                                                    <textarea class="form-control form-control-sm" id="description" name="description" required placeholder="" ></textarea>
                                                </div>
                                                </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-12">
                        <div class="card-body p-3">
                        <div class="row">
                            <div>
                                <h6>PRECIO
                                    <button class="btn btn-link btn-nav-accordion collapsed" style="cursor: pointer; color: #495057;float: right;" type="button" data-bs-toggle="collapse" data-bs-target="#colapseInfC2" aria-expanded="false" aria-controls="colapseInfC2">
                                    <i class="fas fa-chevron-up"></i>
                                    </button>
                                </h6>
                            </div>
                            <div id="colapseInfC2" class="collapse" aria-labelledby="infC2" data-bs-parent="#accordionRental">
                                <div class="accordion-body text-sm opacity-8">
                                    <div class="mt-3 row">
                                        <div class="col-12 col-sm-3">
                                            <label>Precio Base</label>
                                            <input class="form-control form-control-sm" id="price_base" type="text" value="0" min="0" name="price_base" required placeholder="1000" />
                                        </div>
                                        <div class="col-12 col-sm-5">
                                            <label>Impuesto</label>
                                            <select class="form-control form-control-sm" id="tax" type="text" name="tax" required>
                                            
                                            </select>
                                        </div>
                                        <div class="col-12 col-sm-4">
                                            <label>Precio total</label>
                                            <input class="form-control form-control-sm" id="price_total" type="text" name="price_total" required placeholder="10000" />
                                        </div>
                                    </div>
                                    <div class="mr-3 row">
                                        <div class="col-12 col-sm-4">
                                            <label>Costo inicial</label>
                                            <input class="form-control form-control-sm" id="price_init" type="text" name="price_init" required placeholder="10000" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-12">
                        <div class="card-body p-3">
                            <div class="row">
                                <div>
                                    <h6>DETALLE DE INVENTARIO
                                        <button class="btn btn-link btn-nav-accordion collapsed" style="cursor: pointer; color: #495057;float: right;" type="button" data-bs-toggle="collapse" data-bs-target="#colapseInfC" aria-expanded="false" aria-controls="colapseInfC">
                                        <i class="fas fa-chevron-up"></i>
                                        </button>
                                    </h6>
                                </div>
                                <div id="colapseInfC" class="collapse" aria-labelledby="infC" data-bs-parent="#accordionRental">
                                    <div class="accordion-body text-sm opacity-8">
                                        <div class="mt-1 row">
                                            <div class="mt-3">
                                                <div class="pt-0 ps-0 ms-0" id="containerInventory">
                                                </div>
                                                <input type="hidden" id="store_list" name="store_list" value="[]">
                                                <button type="button" onclick="addStoreByObject(null)" class="btn btn-xl btn-success" id="buttonAlmacenAdd">Agregar almacen</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-md-12 col-12">
                        <div class="card-body p-3">
                            <div class="row">
                                <div>
                                    <h6>LISTAS DE PRECIOS
                                        <button class="btn btn-link btn-nav-accordion collapsed" style="cursor: pointer; color: #495057;float: right;" type="button" data-bs-toggle="collapse" data-bs-target="#colapseInfC3" aria-expanded="false" aria-controls="colapseInfC3">
                                        <i class="fas fa-chevron-up"></i>
                                        </button>
                                    </h6>
                                </div>
                                <div id="colapseInfC3" class="collapse" aria-labelledby="infC3" data-bs-parent="#accordionRental">
                                    <div class="accordion-body text-sm opacity-8">
                                        <div class="mt-1 row">
                                            <div class="mt-3">
                                                <div class="pt-0 ps-0 ms-0" id="containerPrecio">
                                                </div>
                                                <input type="hidden" name="price_list" id="price_list" value="[]">
                                                <button type="button" onclick="addPriceByObject(null)" class="btn btn-xl btn-success" id="buttonPriceAdd">Agregar precio</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            
        </div>
        <div class="col-md-4 mt-4">
            <div class="card">
                <div class="card-body">
                    <div class="mt-3 row">
                        <div class="col-12 col-sm-12">
                            <label>Producto image</label>
                            <img src="{% if product.image_b64 %}data:image/jpeg;base64,{{product.image_b64}}{% else %}{% static 'assets/img/file_upload.png' %}{% endif %}" id="imageProduct" alt="image" class="w-50">
                            <input type="file" name="file" id="file" class="form-control form-control-sm">
                            <!-- <div action="/file-upload" class="form-control dropzone" id="productImg" name="productImg"></div> -->
                        </div>           
                        <div class="col-12 col-sm-12 mt-4">
                            <div class="form-check form-switch ps-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Mantén activada esta opción para llevar el control de costos y cantidades">
                                <input class="form-check-input ms-auto" type="checkbox" id="inventoryProduct" name="inventoryProduct" {% if product.inventory %}checked{% endif %}>
                                <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="inventoryProduct">Inventariable</label>
                            </div>
                        </div>
                        <div class="col-12 col-sm-12">
                            <div class="form-check form-switch ps-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Vende sin unidades disponibles">
                                <input class="form-check-input ms-auto" type="checkbox" id="negativeSale" name="negativeSale" {% if product.negative_sale %}checked{% endif %}>
                                <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="negativeSale" id="negativeSaleLabel">Venta en negativo</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <input type="hidden" value="0" id="pk" name="pk">
                        {% if not request.GET.pk or request.GET.edit == 'true' %}
                        <button type="button" class="btn btn-dark btn-sm" onclick="window.location.href='product-view?pk={{request.GET.pk}}&edit={{request.GET.edit}}'">Cancelar</button> 
                        <button type="submit" class="btn btn-dark btn-sm" id="buttonSave">Guardar</button>
                        {% endif %}
                    </div>
            </div>
        </div>
    </div>
</form>
    
</div>
    
    <script src="{% static 'assets/js/plugins/dropzone.min.js' %}"></script>
      {% include 'includes/scripts.html' %}
      {% include 'app/inventory/modal-store-add.html' %}
      <script>
        const taxs = textToJson('{{tax}}');
        taxs.map(function (value, index){
            $("#tax").append(
                '<option value="'+value.pk+'">'+value.name+' ('+value.tax+'%)</option>'
            );
        });
        $("#price_base").change(function(){
            getPrice($("#tax").val(), $(this).val());
        })
        $("#price_base").keyup(function(){
            getPrice($("#tax").val(), $(this).val());
        })
        $("#tax").change(function(elem){
            var elem = $(this).val();
            getPrice(elem, $("#price_base").val());
        });
        $("#price_init").keyup(function(){
            document.getElementById("price_init").value = formatPrice($(this).val());
        })
        $("#price_init").change(function(elem){
            document.getElementById("price_init").value = formatPrice($(this).val());
        });
        function getPrice(elem, price){
            taxs.map(function (value, index){
                if (elem == parseInt(value.pk)){
                    calculaTax(value.tax, price)
                }
            });
        }
        function calculaTax(tax, price){
            var valTax = (parseFloat(clearPrice(price)) * parseInt(tax)) / 100
            document.getElementById("price_total").value = formatPrice((parseFloat(clearPrice(price)) + parseFloat(valTax)).toString());
            document.getElementById("price_base").value = formatPrice(price);
        }

        $("#inventoryProduct").click(function(){
            changeCheck($(this).prop("checked"));
        });
        function changeCheck(valueCheck){
            if (valueCheck){
                document.getElementById("negativeSale").classList.remove('d-none');
                document.getElementById("negativeSaleLabel").classList.remove('d-none');
            }else{
                document.getElementById("negativeSale").classList.add('d-none');
                document.getElementById("negativeSaleLabel").classList.add('d-none');
            }
        }
        // function showModal(pkProduct, codeIn, itemId, name, cant, price, cost, description, type_product, um, tax, save = true){
        //     document.getElementById("pk").value = pkProduct;
        //     document.getElementById("name").value = name;
        //     document.getElementById("cant").value = cant;
        //     document.getElementById("code").value = codeIn;
        //     document.getElementById("code_sat").value = itemId;
        //     document.getElementById("price_total").value = price;
        //     document.getElementById("price_base").value = cost;
        //     document.getElementById("description").value = description;
        //     document.getElementById("um").value = um;
        //     document.getElementById("tax").value = tax;
            
        //     document.getElementById("type_product").value = type_product;
        //     if (type_product == "True"){
        //         $("#customRadio1").prop("checked", true);
        //     }else{
        //         $("#customRadio2").prop("checked", true);
        //     }
        //     //$("#formId").attr("action", "/update-product");
        //     if (!save){
        //         removeButton();
        //     }else{
        //         removeButton();
        //         addButton();
        //     }
        // }
        // function clearModal(){
        //     document.getElementById("pk").value = "0";
        //     document.getElementById("code").value = "";
        //     document.getElementById("name").value = "";
        //     document.getElementById("cant").value = "0";
        //     document.getElementById("code_sat").value = "";
        //     document.getElementById("price_total").value = "";
        //     document.getElementById("price_base").value = "0";
        //     document.getElementById("description").value = "";
        //     document.getElementById("um").value = "1";
        //     document.getElementById("tax").value = "1";
        //     //$("#formId").attr("action", "/create-product");
        //     removeButton();
        //     addButton();
        // }

        // ------------- init store ------------------
        var contStore = 0;
        var contPrice = 0;
        var storeObject = {};
        var priceObject = {};
        function addStoreByObject(valueStore=null){
            if (valueStore == null){
                storeObject[contStore] = {
                    "pk":0,
                    "store":0,
                    "cant_init":0,
                    "cant_min":0,
                    "cant_max":0
                }
            }else{
                storeObject[contStore] = valueStore;
            }
            document.getElementById("store_list").value = JSON.stringify(Object.values(storeObject));
            addStore(storeObject[contStore]);
        }
        function addStore(valueStore){
            textOptions = "";
            textOptions += '<option value="" selected>Seleccionar</option>'
            '{% for s in store %}'
                if (parseInt('{{s.pk}}') == parseInt(valueStore.store)){
                    textOptions += '<option value="{{s.pk}}" selected>{{s.name}}</option>'
                }else{
                    textOptions += '<option value="{{s.pk}}">{{s.name}}</option>'
                }
            '{% endfor %}'
            _disabled = "";
            if('{{request.GET.edit}}' == "false"){
                _disabled = "disabled";
            }
            $("#containerInventory").append(
                '<div class="row mb-4" id="store_add'+contStore+'">'+
                    '<div class="col-md-4">'+
                        '<label class="text-xs">Almacen</label>'+
                        '<select class="form-control form-control-sm" value="'+valueStore.store+'" id="pk_store_add'+contStore+'" '+_disabled+'>'+
                            ''+textOptions+''+
                        '</select>'+
                    '</div>'+
                    '<div class="col-md-2">'+
                        '<label class="text-xs">Cant. inicial</label>'+
                        '<input type="text" class="form-control form-control-sm" id="cant_init_store'+contStore+'" value="'+valueStore.cant_init+'" '+_disabled+'>'+
                    '</div>'+
                    '<div class="col-md-2">'+
                        '<label class="text-xs">Cant. minima</label>'+
                        '<input type="text" class="form-control form-control-sm" id="cant_min_store'+contStore+'" value="'+valueStore.cant_min+'" '+_disabled+'>'+
                    '</div>'+
                    '<div class="col-md-2">'+
                        '<label class="text-xs">Cant. maxima</label>'+
                        '<input type="text" class="form-control form-control-sm" id="cant_max_store'+contStore+'" value="'+valueStore.cant_max+'" '+_disabled+'>'+
                    '</div>'+
                    '<div class="col-md-2 mt-4">'+
                        '<button type="button" class="btn btn-link mt-1" onclick="removeStore(\''+contStore+'\')" '+_disabled+'>Eliminar</button>'+
                    '</div>'+
                '</div>'
            );
            addScriptStore(contStore);
            contStore += 1;
        }
        function addScriptStore(contStoreValue){
            $("#cant_init_store"+contStoreValue).change(function(){
                changeCantInit($(this).val(), contStoreValue);
            });
            $("#cant_init_store"+contStoreValue).keyup(function(){
                changeCantInit($(this).val(), contStoreValue);
            });
            $("#cant_min_store"+contStoreValue).change(function(){
                changeCantMin($(this).val(), contStoreValue);
            });
            $("#cant_min_store"+contStoreValue).keyup(function(){
                changeCantMin($(this).val(), contStoreValue);
            });
            $("#cant_max_store"+contStoreValue).change(function(){
                changeCantMax($(this).val(), contStoreValue);
            });
            $("#cant_max_store"+contStoreValue).keyup(function(){
                changeCantMax($(this).val(), contStoreValue);
            });
            $("#pk_store_add"+contStoreValue).change(function(){
                changeStore($(this).val(), contStoreValue);
            });
        }
        function changeCantInit(valueIn, contStoreValue){
            storeObject[contStoreValue].cant_init = valueIn;
            document.getElementById("store_list").value = JSON.stringify(Object.values(storeObject));
        }
        function changeCantMin(valueIn, contStoreValue){
            storeObject[contStoreValue].cant_min = valueIn;
            document.getElementById("store_list").value = JSON.stringify(Object.values(storeObject));
        }
        function changeCantMax(valueIn, contStoreValue){
            storeObject[contStoreValue].cant_max = valueIn;
            document.getElementById("store_list").value = JSON.stringify(Object.values(storeObject));
        }
        function changeStore(valueIn, contStoreValue){
            storeObject[contStoreValue].store = valueIn;
            document.getElementById("store_list").value = JSON.stringify(Object.values(storeObject));
        }
        function removeStore(contStoreValue){
            $("#store_add"+contStoreValue).remove();
            delete storeObject[contStoreValue];
            document.getElementById("store_list").value = JSON.stringify(Object.values(storeObject));
        }
        // ---------------- end store ----------------------------
        // ----------------- init price ------------------------
        function addPriceByObject(valuePrice=null){
            if (valuePrice == null){
                priceObject[contPrice] = {
                    "pk": 0,
                    "price":0,
                    "valor":0,
                }
            }else{
                priceObject[contPrice] = valuePrice;
            }
            document.getElementById("price_list").value = JSON.stringify(Object.values(priceObject));
            addPrice(priceObject[contPrice]);
        }
        function addPrice(valuePrice){
            textOptions = "";
            textOptions += '<option value="" selected>Seleccionar</option>';
            '{% for lp in list_price %}'
                if (parseInt('{{lp.pk}}') == parseInt(valuePrice.price)){
                    textOptions += '<option value="{{lp.pk}}" selected>{{lp.name}}</option>'
                }else{
                    textOptions += '<option value="{{lp.pk}}">{{lp.name}}</option>'
                }
            '{% endfor %}'
            _disabled = "";
            if('{{request.GET.edit}}' == "false"){
                _disabled = "disabled";
            }
            $("#containerPrecio").append(
                '<div class="row mb-4" id="list_price'+contPrice+'">'+
                    '<div class="col-sm-5">'+
                        '<label class="text-xs">Lista de precio</label>'+
                        '<select class="form-control form-control-sm" id="price_store'+contPrice+'" value="'+valuePrice.price+'" '+_disabled+'>'+
                            ''+textOptions+''+
                        '</select>'+
                    '</div>'+
                    '<div class="col-sm-5">'+
                        '<label class="text-xs">Valor</label>'+
                        '<input type="text" class="form-control form-control-sm" id="valor'+contPrice+'" value="'+formatPrice(valuePrice.valor)+'" '+_disabled+'>'+
                    '</div>'+
                    '<div class="col-sm-2 mt-4">'+
                        '<button type="button" class="btn btn-link mt-1" onclick="removePrice(\''+contPrice+'\')" '+_disabled+'>Eliminar</button>'+
                    '</div>'+
                '</div>'
            );
            addScriptPrice(contPrice);
            contPrice += 1;
        }
        function addScriptPrice(contPriceValue){
            $("#valor"+contPriceValue).change(function(){
                changeValuePrice($(this).val(), contPriceValue);
                $(this).prop("value", formatPrice($(this).val()));
            });
            $("#valor"+contPriceValue).keyup(function(){
                changeValuePrice($(this).val(), contPriceValue);
                $(this).prop("value", formatPrice($(this).val()));
            });
            $("#price_store"+contPriceValue).change(function(){
                changePrice($(this).val(), contPriceValue);
            });
        }
        function changeValuePrice(valueIn, contPriceValue){
            priceObject[contPriceValue].valor = clearPrice(valueIn);
            document.getElementById("price_list").value = JSON.stringify(Object.values(priceObject));
        }
        function changePrice(valueIn, contPriceValue){
            priceObject[contPriceValue].price = valueIn;
            document.getElementById("price_list").value = JSON.stringify(Object.values(priceObject));
        }
        function removePrice(contPriceValue){
            $("#list_price"+contPriceValue).remove();
            delete priceObject[contPriceValue];
            document.getElementById("price_list").value = JSON.stringify(Object.values(priceObject));
        }
        // --------------------------- End price -------------------
        function addButton(){
            $("#buttons").append(
                '<button type="button" class="btn btn-white btn-sm" data-bs-dismiss="modal">Cerrar</button>'+
                '<button type="submit" class="btn btn-dark btn-sm">Guardar</button>'
            )
        }
        function removeButton(){
            $("#buttons").text("");
        }
        $("#customRadio1").change(function(){
            document.getElementById("type_product").value = true
        })
        $("#customRadio2").change(function(){
            document.getElementById("type_product").value = false
        })

        function viewModelData(pkProduct, codeIn, itemId, name, cant, price, cost, description, type_product, um, tax, price_init, save = true){
            document.getElementById("pk").value = pkProduct;
            document.getElementById("code").value = codeIn;
            document.getElementById("name").value = name;
            document.getElementById("cant").value = cant;
            document.getElementById("code_sat").value = itemId;
            document.getElementById("price_total").value = formatPrice(price);
            document.getElementById("price_base").value = formatPrice(cost);
            document.getElementById("price_init").value = formatPrice(price_init);
            document.getElementById("description").value = description;
            document.getElementById("um").value = um;
            document.getElementById("tax").value = tax;
            //document.getElementById("store").value = pk_store;
            
            if (type_product == "True"){
                $("#customRadio1").prop("checked", true);
                document.getElementById("type_product").value = true;
            }else{
                $("#customRadio2").prop("checked", true);
                document.getElementById("type_product").value = false;
            }
            if (save){
                document.getElementById("buttonSave").classList.remove('d-none');
                document.getElementById("buttonSave").textContent = "Modificar";
            }else{
                document.getElementById("buttonSave").classList.add('d-none');
            }
            //modalCalendarClick.show();
            //searchItem(itemId, false);
            changeElements(save);
        }
        function changeElements(save){
            $("#name").prop("disabled", !save);
            $("#cant").prop("disabled", !save);
            $("#code").prop("disabled", !save);
            $("#code_sat").prop("disabled", !save);
            $("#price_total").prop("disabled", !save);
            $("#price_base").prop("disabled", !save);
            $("#description").prop("disabled", !save);
            $("#um").prop("disabled", !save);
            $("#tax").prop("disabled", !save);
            $("#store").prop("disabled", !save);
            $("#price_init").prop("disabled", !save);
            $("#category").prop("disabled", !save);
            $("#buttonAlmacenAdd").prop("disabled", !save);
            $("#buttonPriceAdd").prop("disabled", !save);
            $("#file").prop("disabled", !save);
            $("#inventoryProduct").prop("disabled", !save);
        }
    let codeSat = [];//textToJson('{{code_prod_serv}}');
    if (document.getElementById('ref')) {
        var selectCodeSat = $('#ref');
      //var selectCodeSat = document.getElementById('ref');
      //setTimeout(function() {
      //  const example = new Choices(selectCodeSat);
      //}, 1);
    }
    function clearSelectCodeSat(){
        selectCodeSat.text("");
    }
    function addSelectCodeSat(value, text, optionSelected=false){
        selectCodeSat.append("<option value='"+value+"'>"+text+"</option>");
    //   var optn = document.createElement("OPTION");
    //   optn.text = text;
    //   optn.value = value;
    //   optn.selected = optionSelected;
    //   selectCodeSat.options.add(optn);
      /*if (optionSelected){
        setTimeout(function(){
          document.getElementById("code_sat").value = value;
        },1);
      }*/
    }
    let timeout
    $("#code_sat").keydown(function(){
      clearTimeout(timeout)
      timeout = setTimeout(() => {
        console.log('Has dejado de escribir en el input')
        searchItem(document.getElementById("code_sat").value);
        clearTimeout(timeout)
      },1000);
    });
    async function searchItem(valueSearch, sl=true){
      clearSelectCodeSat();
      addSelectCodeSat(codeSat[0].code, codeSat[0].name, sl);
      cont = 0;
      for(i=0; i<codeSat.length; i++){
        if (
          (codeSat[i].code.toString().toLowerCase().includes(valueSearch.toString().toLowerCase()) || 
          codeSat[i].name.toString().toLowerCase().includes(valueSearch.toString().toLowerCase())) && 
          valueSearch != "" && valueSearch != " "
        ){
          //console.log(codeSat[i]);
          cont += 1;
          if (sl == false){
            addSelectCodeSat(codeSat[i].code, codeSat[i].name, true);
          }else{
            addSelectCodeSat(codeSat[i].code, codeSat[i].name);
          }
          if (cont > 500){
            break;
          }
        }
      };
    }
    function getCodeProdServ(){
      $.ajax({
          url: '/get-code-prod-serv',
          type: 'POST',
          data:{},
          headers: {"X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()},
          success: function(json) {
            //console.log(json);
            codeSat = JSON.parse(json);
            //console.log(codeSat);
            searchItem('{{product.code}}', false);
          },
          error: function(error) {
            console.log("Ocurrio un error");
          }
      });
    }
    getCodeProdServ();
    '{% if request.GET.pk %}'
        _edit = false;
        if ('{{request.GET.edit}}' == "true"){
            _edit = true;
        }
        setTimeout(function(){
            viewModelData(
                '{{product.pk}}',
                '{{product.code_in}}',  
                '{{product.code}}', 
                '{{product.name}}', 
                '{{product.quantity}}',
                '{{product.price_1}}',
                '{{product.cost}}',
                '{{product.description}}',
                '{{product.type_product}}',
                '{{product.unit_measure}}',
                '{{product.tax}}',
                '{{product.price_init}}',
                _edit
            );
        },100);
    '{% else %}'
        document.getElementById("price_total").value = formatPrice("0");
        document.getElementById("price_base").value = formatPrice("0");
        document.getElementById("price_init").value = formatPrice("0");
        changeElements(true);
    '{% endif %}'
    '{% for p in product.price_list %}'
        addPriceByObject({
            "pk": '{{p.pk}}',
            "price":'{{p.list_price}}',
            "valor":'{{p.valor}}'
        });
    '{% endfor %}'
    '{% for p in product.store_list %}'
        addStoreByObject({
            "pk":'{{p.pk}}',
            "store":'{{p.store}}',
            "cant_init":'{{p.cant_init}}',
            "cant_min":'{{p.cant_min}}',
            "cant_max":'{{p.cant_max}}'
        });
    '{% endfor %}'
    '{% if product.inventory %}'
        changeCheck(true);
    '{% else %}'
        changeCheck(false);
    '{% endif %}'

    </script>

      {% endblock content %}
  
      <!-- Specific JS goes HERE --> 
      {% block javascripts %}
      
      {% endblock javascripts %}